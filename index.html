<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPPG Creator Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;800&family=Pacifico&display=swap" rel="stylesheet">
    <style>
        /* CSS Animatif & Glassmorphism Gen Z Vibe */
        :root {
            --primary: #7F00FF;
            --secondary: #E100FF;
            --bg-glass: rgba(255, 255, 255, 0.75);
            --border-glass: rgba(255, 255, 255, 0.5);
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        body { 
            font-family: 'Outfit', sans-serif; 
            margin: 0; padding: 20px; 
            background: linear-gradient(-45deg, #ff9a9e, #fecfef, #a1c4fd, #c2e9fb);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            display: flex;
            justify-content: center;
            color: #333;
            /* Tambahan CSS biar teks nggak bisa di-blok/highlight */
            user-select: none;
            -webkit-user-select: none;
        }

        @keyframes gradientBG {
            0% {background-position: 0% 50%;}
            50% {background-position: 100% 50%;}
            100% {background-position: 0% 50%;}
        }

        .container { 
            width: 100%; max-width: 650px; 
            background: var(--bg-glass); 
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 30px; 
            border-radius: 24px; 
            border: 1px solid var(--border-glass);
            box-shadow: var(--shadow); 
            transition: transform 0.3s ease;
        }

        .header-section { text-align: center; margin-bottom: 25px; }
        h2 { 
            color: #111; margin: 0 0 5px 0; 
            font-family: 'Pacifico', cursive; 
            font-size: 32px;
            background: -webkit-linear-gradient(45deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .subtitle { font-size: 14px; color: #555; font-weight: 500; }

        /* Canvas & Drag-Drop UI */
        .canvas-wrapper {
            position: relative; width: 100%; max-width: 540px; margin: 0 auto;
            border-radius: 20px; overflow: hidden; touch-action: none;
            box-shadow: 0 10px 20px rgba(0,0,0,0.15);
            transition: all 0.3s ease;
            border: 3px dashed transparent;
        }
        .canvas-wrapper.drag-over {
            border-color: var(--primary);
            transform: scale(1.02);
            box-shadow: 0 15px 30px rgba(127, 0, 255, 0.3);
        }
        .drag-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.8);
            display: flex; justify-content: center; align-items: center;
            font-size: 20px; font-weight: 800; color: var(--primary);
            pointer-events: none; opacity: 0; transition: 0.3s;
        }
        .canvas-wrapper.drag-over .drag-overlay { opacity: 1; }
        canvas { width: 100%; height: auto; display: block; cursor: crosshair; }

        /* Form Controls */
        .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 25px; }
        .full-width { grid-column: span 2; }
        
        .card-panel { 
            background: rgba(255, 255, 255, 0.6); 
            padding: 15px; border-radius: 16px; 
            border: 1px solid rgba(255,255,255,0.8);
            transition: 0.3s;
        }
        .card-panel:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.05); }

        input { 
            width: 100%; padding: 12px; 
            border: 2px solid transparent; 
            border-radius: 12px; font-family: 'Outfit'; font-size: 14px; 
            box-sizing: border-box; background: rgba(255,255,255,0.9);
            transition: 0.3s; box-shadow: inset 0 2px 4px rgba(0,0,0,0.02);
        }
        input:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 4px rgba(127,0,255,0.1); }
        
        label { font-size: 12px; font-weight: 800; color: #444; display: block; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; }
        
        .section-header { 
            grid-column: span 2; background: linear-gradient(90deg, #111, #333); 
            color: white; padding: 8px 15px; font-size: 13px; border-radius: 10px; 
            margin-top: 15px; font-weight: 800; letter-spacing: 1px;
        }

        /* Modern Custom File Input */
        input[type="file"] {
            padding: 10px; background: #fff; border: 2px dashed #ccc; cursor: pointer; text-align: center;
        }
        input[type="file"]:hover { border-color: var(--primary); background: rgba(127,0,255,0.05); }

        /* Buttons Gen Z Style */
        .btn-group { display: flex; gap: 10px; margin-top: 25px; }
        button { 
            color: white; padding: 16px; border: none; border-radius: 16px; 
            font-size: 16px; font-weight: 800; font-family: 'Outfit'; 
            cursor: pointer; width: 100%; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        button:hover { transform: translateY(-4px) scale(1.02); }
        button:active { transform: translateY(2px) scale(0.98); }
        
        .btn-download { background: linear-gradient(135deg, #00F260, #0575E6); box-shadow: 0 8px 20px rgba(5, 117, 230, 0.3); }
        .btn-copy { background: linear-gradient(135deg, #f12711, #f5af19); box-shadow: 0 8px 20px rgba(241, 39, 17, 0.3); }

        /* Layer Buttons */
        .layer-controls { display: flex; align-items: center; justify-content: space-between; margin-top: 10px; }
        .btn-layer { padding: 8px 15px; font-size: 12px; border-radius: 8px; background: #eee; color: #333; font-weight: 600; width: auto; box-shadow: none; }
        .btn-layer:hover { background: #ddd; transform: none; }
        .btn-layer.active { background: var(--primary); color: white; }
        .btn-delete { background: #ff4757; color: white; padding: 8px 15px; border-radius: 8px; font-size: 12px; width: auto; box-shadow: none;}
        
        /* Checkbox modern */
        .checkbox-wrapper { display: flex; align-items: center; gap: 8px; margin-top: 10px; background: #fff; padding: 10px 15px; border-radius: 10px; border: 1px solid #eee; }
        .checkbox-wrapper input { width: 20px; height: 20px; accent-color: var(--primary); cursor: pointer; }
        .checkbox-wrapper label { margin: 0; cursor: pointer; font-size: 13px; font-weight: 600; text-transform: none; }
        
    </style>
</head>
<body>

<div class="container">
    <div class="header-section">
        <h2>SPPG Menu Pro ‚ú®</h2>
        <div class="subtitle">Designed by Fadlan Kharisma Aji Nugroho</div>
    </div>

    <div class="canvas-wrapper" id="dropZone">
        <div class="drag-overlay">‚ú® Drop Stiker Disini ‚ú®</div>
        <canvas id="myCanvas" width="1080" height="1080"></canvas>
    </div>

    <div class="controls">
        <div class="card-panel full-width" style="border: 2px solid var(--primary); background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(255,255,255,0.6));">
            <label>üñºÔ∏è Upload Background (Tersimpan Otomatis)</label>
            <input type="file" id="bgInput" accept="image/*">
            <div style="display:flex; justify-content: flex-end; margin-top: 8px;">
                <button onclick="resetBackground()" style="background: #ff4757; padding: 8px 15px; font-size: 12px; width: auto; box-shadow: none;">üóëÔ∏è Reset BG</button>
            </div>
        </div>

        <div class="card-panel full-width">
            <label>‚ú® Upload / Drop Hiasan (Stiker)</label>
            <input type="file" id="stickerInput" accept="image/*" multiple>
            
            <div class="checkbox-wrapper">
                <input type="checkbox" id="autoRemoveBg" checked>
                <label for="autoRemoveBg">Auto-Hapus Background Putih</label>
            </div>
            
            <div id="selectedStickerUI" style="display:none; margin-top: 15px; padding-top: 15px; border-top: 2px dashed #ddd;">
                <label>üéöÔ∏è Edit Stiker Terpilih</label>
                <input type="range" id="stickerScale" min="0.1" max="3.0" step="0.1" value="1.0" oninput="resizeSelectedSticker()" style="margin-bottom:10px;">
                <div class="layer-controls">
                    <div style="display: flex; gap: 5px;">
                        <button class="btn-layer" id="btnLayerBottom" onclick="setStickerLayer('bottom')">‚è¨ Belakang</button>
                        <button class="btn-layer" id="btnLayerTop" onclick="setStickerLayer('top')">‚è´ Depan</button>
                    </div>
                    <button class="btn-delete" onclick="deleteSelectedSticker()">üóëÔ∏è Hapus</button>
                </div>
            </div>
            <div id="noStickerMsg" style="margin-top:10px; font-size:12px; color:#888; font-style:italic; text-align: center;">
                (Klik stiker di gambar untuk mengedit)
            </div>
        </div>

        <div class="card-panel full-width">
            <label>üì∏ Foto Makanan Utama</label>
            <input type="file" id="foodInput" accept="image/*">
        </div>
        
        <div class="card-panel full-width">
            <label>üìÖ Tanggal Menu</label>
            <input type="date" id="datePicker">
        </div>
        
        <div class="card-panel full-width">
            <label>üì± Social Media</label>
            <input type="text" id="tiktok" value="TikTok: @SppgPanjatan002" oninput="updateText('tiktok', 6)">
        </div>

        <div class="section-header">üçΩÔ∏è DAFTAR MENU</div>
        <div class="full-width"><input type="text" id="menu1" value="Ayam Bakar Madu" oninput="updateText('menu1', 1)"></div>
        <div><input type="text" id="menu2" value="Tahu Goreng" oninput="updateText('menu2', 2)"></div>
        <div><input type="text" id="menu3" value="Lalapan" oninput="updateText('menu3', 3)"></div>
        <div><input type="text" id="menu4" value="Anggur Merah" oninput="updateText('menu4', 4)"></div>
        <div><input type="text" id="menu5" value="Nasi Putih" oninput="updateText('menu5', 5)"></div>

        <div class="section-header">‚ö° GIZI KECIL (KIRI)</div>
        <div><label>Energi</label><input type="number" id="k_energi" value="468" oninput="draw()"></div>
        <div><label>Protein</label><input type="number" id="k_protein" value="22" oninput="draw()"></div>
        <div><label>Lemak</label><input type="number" id="k_lemak" value="19" oninput="draw()"></div>
        <div><label>Karbo</label><input type="number" id="k_karbo" value="52" oninput="draw()"></div>
        <div class="full-width"><label>Serat</label><input type="number" id="k_serat" value="3" oninput="draw()"></div>

        <div class="section-header">üî• GIZI BESAR (KANAN)</div>
        <div><label>Energi</label><input type="number" id="b_energi" value="594" oninput="draw()"></div>
        <div><label>Protein</label><input type="number" id="b_protein" value="24" oninput="draw()"></div>
        <div><label>Lemak</label><input type="number" id="b_lemak" value="20" oninput="draw()"></div>
        <div><label>Karbo</label><input type="number" id="b_karbo" value="80" oninput="draw()"></div>
        <div class="full-width"><label>Serat</label><input type="number" id="b_serat" value="3" oninput="draw()"></div>
    </div>

    <div class="btn-group">
        <button class="btn-copy" onclick="copyImageToClipboard()">üìã Salin Gambar</button>
        <button class="btn-download" onclick="downloadImage()">üì• Download (PNG)</button>
    </div>
</div>

<script>
    const canvas = document.getElementById('myCanvas');
    const ctx = canvas.getContext('2d');

    let bgImg = new Image();
    let bgLoaded = false;
    let foodImg = new Image();
    let foodLoaded = false;

    let stickers = [];
    let selectedStickerIndex = -1;
    
    // Teks Init
    let textObjects = [
        { id: 'dateText', text: '', x: 1020, y: 270, font: "400 24px 'Pacifico'", align: 'right', color: '#001F54', stroke: true },
        { id: 'menu1', text: 'Ayam Bakar Madu', x: 540, y: 280, font: "400 32px 'Pacifico'", align: 'center', color: '#222', stroke: true },
        { id: 'menu2', text: 'Tahu Goreng', x: 200, y: 380, font: "400 28px 'Pacifico'", align: 'center', color: '#222', stroke: true },
        { id: 'menu3', text: 'Lalapan', x: 880, y: 380, font: "400 28px 'Pacifico'", align: 'center', color: '#222', stroke: true },
        { id: 'menu4', text: 'Anggur Merah', x: 200, y: 560, font: "400 28px 'Pacifico'", align: 'center', color: '#222', stroke: true },
        { id: 'menu5', text: 'Nasi Putih', x: 880, y: 560, font: "400 28px 'Pacifico'", align: 'center', color: '#222', stroke: true },
        { id: 'tiktok', text: 'TikTok: @SppgPanjatan002', x: 540, y: 1040, font: "600 24px 'Outfit'", align: 'center', color: '#000', stroke: false }
    ];

    let isDragging = false, dragType = null, dragIndex = -1;
    let startX, startY;

    // Format Tanggal Indonesia
    function getIndonesianDate(dateString) {
        if (!dateString) return '';
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        const d = new Date(dateString);
        return d.toLocaleDateString('id-ID', options);
    }

    // Load Init & LocalStorage Check
    document.fonts.ready.then(() => {
        const savedBg = localStorage.getItem('sppg_saved_bg');
        if (savedBg) {
            bgImg.src = savedBg;
            bgImg.onload = () => { bgLoaded = true; draw(); }
        }

        const datePicker = document.getElementById('datePicker');
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, '0');
        const dd = String(today.getDate()).padStart(2, '0');
        datePicker.value = `${yyyy}-${mm}-${dd}`;
        textObjects[0].text = getIndonesianDate(datePicker.value);
        
        draw();
    });

    // Upload Background & Save to LocalStorage
    document.getElementById('bgInput').addEventListener('change', function(e) {
        if (!e.target.files[0]) return;
        const reader = new FileReader();
        reader.onload = function(event) {
            const base64Str = event.target.result;
            bgImg.src = base64Str;
            bgImg.onload = () => { bgLoaded = true; draw(); }
            
            try {
                localStorage.setItem('sppg_saved_bg', base64Str);
            } catch (err) {
                alert("Waduh, ukuran background kamu kegedean nih buat disimpen otomatis di browser (maks 5MB). Coba compress dulu fotonya ya! ü•≤");
            }
        }
        reader.readAsDataURL(e.target.files[0]);
    });

    // Reset Background
    window.resetBackground = function() {
        localStorage.removeItem('sppg_saved_bg');
        bgImg.src = '';
        bgLoaded = false;
        document.getElementById('bgInput').value = '';
        draw();
    }

    document.getElementById('datePicker').addEventListener('change', function() {
        textObjects[0].text = getIndonesianDate(this.value);
        draw();
    });

    document.getElementById('foodInput').addEventListener('change', function(e) {
        if (!e.target.files[0]) return;
        const reader = new FileReader();
        reader.onload = function(event){ 
            foodImg.src = event.target.result; 
            foodImg.onload = () => { foodLoaded = true; draw(); }
        }
        reader.readAsDataURL(e.target.files[0]);
    });

    document.getElementById('stickerInput').addEventListener('change', function(e) {
        handleStickerFiles(e.target.files);
    });

    const dropZone = document.getElementById('dropZone');
    
    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('drag-over');
    });
    
    dropZone.addEventListener('dragleave', (e) => {
        e.preventDefault();
        dropZone.classList.remove('drag-over');
    });
    
    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('drag-over');
        
        const files = e.dataTransfer.files;
        if(files.length > 0) {
            handleStickerFiles(files);
        }
    });

    function handleStickerFiles(files) {
        if (!files || !files.length) return;
        const autoRemove = document.getElementById('autoRemoveBg').checked;

        Array.from(files).forEach(file => {
            if (!file.type.startsWith('image/')) return;
            const reader = new FileReader();
            reader.onload = function(event) {
                let tempImg = new Image();
                tempImg.onload = function() {
                    if (autoRemove) {
                        processMagicEraser(tempImg, (processedImg) => pushSticker(processedImg));
                    } else {
                        pushSticker(tempImg);
                    }
                }
                tempImg.src = event.target.result;
            }
            reader.readAsDataURL(file);
        });
    }

    function processMagicEraser(imgElement, callback) {
        const c = document.createElement('canvas');
        c.width = imgElement.width; c.height = imgElement.height;
        const cx = c.getContext('2d');
        cx.drawImage(imgElement, 0, 0);
        let imgData = cx.getImageData(0, 0, c.width, c.height);
        let data = imgData.data;
        for(let i = 0; i < data.length; i += 4) {
            if (data[i] > 230 && data[i+1] > 230 && data[i+2] > 230) data[i+3] = 0;
        }
        cx.putImageData(imgData, 0, 0);
        let newImg = new Image(); newImg.onload = function() { callback(newImg); }; newImg.src = c.toDataURL();
    }

    function pushSticker(loadedImg) {
        stickers.push({
            img: loadedImg,
            x: 540 - (loadedImg.width/2),
            y: 540 - (loadedImg.height/2),
            baseWidth: loadedImg.width,
            baseHeight: loadedImg.height,
            scale: 1.0,
            layer: 'top' 
        });
        selectSticker(stickers.length - 1);
        draw();
    }

    function selectSticker(index) {
        selectedStickerIndex = index;
        const ui = document.getElementById('selectedStickerUI');
        const msg = document.getElementById('noStickerMsg');
        
        if (index === -1) {
            ui.style.display = 'none'; msg.style.display = 'block';
        } else {
            ui.style.display = 'block'; msg.style.display = 'none';
            document.getElementById('stickerScale').value = stickers[index].scale;
            updateLayerButtons(stickers[index].layer);
        }
        draw();
    }

    function updateLayerButtons(layer) {
        document.getElementById('btnLayerBottom').className = layer === 'bottom' ? 'btn-layer active' : 'btn-layer';
        document.getElementById('btnLayerTop').className = layer === 'top' ? 'btn-layer active' : 'btn-layer';
    }

    window.setStickerLayer = function(layer) {
        if (selectedStickerIndex !== -1) {
            stickers[selectedStickerIndex].layer = layer;
            updateLayerButtons(layer);
            draw();
        }
    }

    window.resizeSelectedSticker = function() {
        if (selectedStickerIndex !== -1) {
            stickers[selectedStickerIndex].scale = parseFloat(document.getElementById('stickerScale').value);
            draw();
        }
    }

    window.deleteSelectedSticker = function() {
        if (selectedStickerIndex !== -1) {
            stickers.splice(selectedStickerIndex, 1);
            selectSticker(-1);
        }
    }
    window.updateText = function(id, idx) { textObjects[idx].text = document.getElementById(id).value; draw(); }

    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // 1. BG
        if (bgLoaded) {
            ctx.drawImage(bgImg, 0, 0, 1080, 1080);
        } else { 
            ctx.fillStyle = "#fff"; ctx.fillRect(0,0,1080,1080); 
            ctx.fillStyle="red"; ctx.font="800 30px Outfit"; ctx.textAlign="center"; 
            ctx.fillText("‚ö†Ô∏è UPLOAD BACKGROUND DI BAWAH ‚ö†Ô∏è", 540,540); 
        }

        // 2. Food
        if (foodLoaded) {
            const fx=280, fy=280, fw=520, fh=380;
            ctx.save(); ctx.beginPath(); ctx.roundRect(fx, fy, fw, fh, 30); ctx.clip();
            ctx.drawImage(foodImg, fx, fy, fw, fh); ctx.restore();
            ctx.lineWidth=8; ctx.strokeStyle="#fff"; ctx.strokeRect(fx, fy, fw, fh);
        }

        // 3. Stickers (LAYER BOTTOM)
        stickers.forEach((s) => { if (s.layer === 'bottom') drawSingleSticker(s); });

        // 4. TABEL GIZI
        drawNutritionTable();

        // 5. Texts
        textObjects.forEach(obj => {
            ctx.font = obj.font; ctx.textAlign = obj.align;
            if(obj.stroke) { 
                ctx.lineWidth=5; ctx.strokeStyle="white"; 
                ctx.lineJoin="round"; ctx.miterLimit=2;
                ctx.strokeText(obj.text, obj.x, obj.y); 
            }
            ctx.fillStyle = obj.color; ctx.fillText(obj.text, obj.x, obj.y);
        });

        // 6. Stickers (LAYER TOP)
        stickers.forEach((s) => { if (s.layer === 'top') drawSingleSticker(s); });

        // 7. Selection Box untuk Stiker
        if (selectedStickerIndex !== -1) {
            const s = stickers[selectedStickerIndex];
            const w = s.baseWidth * s.scale; const h = s.baseHeight * s.scale;
            ctx.strokeStyle = "#7F00FF"; ctx.lineWidth = 3; ctx.setLineDash([15, 10]);
            ctx.strokeRect(s.x, s.y, w, h); ctx.setLineDash([]);
        }
    }

    function drawSingleSticker(s) {
        if (!s.img.complete) return;
        const w = s.baseWidth * s.scale; const h = s.baseHeight * s.scale;
        ctx.drawImage(s.img, s.x, s.y, w, h);
    }

    function drawNutritionTable() {
        let k_e = document.getElementById('k_energi').value || 0;
        let k_p = document.getElementById('k_protein').value || 0;
        let k_l = document.getElementById('k_lemak').value || 0;
        let k_k = document.getElementById('k_karbo').value || 0;
        let k_s = document.getElementById('k_serat').value || 0;

        let b_e = document.getElementById('b_energi').value || 0;
        let b_p = document.getElementById('b_protein').value || 0;
        let b_l = document.getElementById('b_lemak').value || 0;
        let b_k = document.getElementById('b_karbo').value || 0;
        let b_s = document.getElementById('b_serat').value || 0;

        // Header Gizi
        ctx.fillStyle = "#111"; ctx.beginPath(); ctx.roundRect(330, 680, 420, 50, 25); ctx.fill();
        ctx.fillStyle = "white"; ctx.font = "800 24px 'Outfit'"; ctx.textAlign = "center";
        ctx.fillText("‚ö° KANDUNGAN GIZI ‚ö°", 540, 715);

        function renderBox(x, title, e, p, l, k, s) {
            // Box Frame
            ctx.fillStyle = "rgba(255, 255, 255, 0.9)"; ctx.beginPath(); ctx.roundRect(x, 740, 400, 240, 25); ctx.fill();
            ctx.strokeStyle = "#eee"; ctx.lineWidth = 2; ctx.stroke();
            
            // Box Title
            ctx.fillStyle = title === 'Porsi Kecil' ? "#7F00FF" : "#E100FF"; 
            ctx.beginPath(); ctx.roundRect(x, 740, 400, 50, [25, 25, 0, 0]); ctx.fill();
            ctx.fillStyle = "white"; ctx.font = "800 24px 'Outfit'"; ctx.textAlign = "center";
            ctx.fillText(title, x + 200, 775);
            
            // Texts
            ctx.fillStyle = "#333"; ctx.font = "600 22px 'Outfit'"; ctx.textAlign = "left";
            const startY = 825; const gap = 35; const textX = x + 30;
            ctx.fillText(`üî• Energi : ${e} kkal`, textX, startY);
            ctx.fillText(`ü•© Protein : ${p} gr`, textX, startY + gap);
            ctx.fillText(`üßà Lemak : ${l} gr`, textX, startY + gap*2);
            ctx.fillText(`üçö Karbohidrat : ${k} gr`, textX, startY + gap*3);
            ctx.fillText(`ü•¶ Serat : ${s} gr`, textX, startY + gap*4);
        }
        renderBox(100, "Porsi Kecil", k_e, k_p, k_l, k_k, k_s);
        renderBox(580, "Porsi Besar", b_e, b_p, b_l, b_k, b_s);
    }

    function getMousePos(evt) {
        var rect = canvas.getBoundingClientRect();
        var scaleX = canvas.width / rect.width; var scaleY = canvas.height / rect.height;
        let cx = evt.clientX; let cy = evt.clientY;
        if(evt.touches && evt.touches.length > 0) { cx = evt.touches[0].clientX; cy = evt.touches[0].clientY; }
        return { x: (cx - rect.left) * scaleX, y: (cy - rect.top) * scaleY };
    }

    function isHitText(pos, obj) {
        ctx.font = obj.font; const w = ctx.measureText(obj.text).width;
        let sx = obj.x; if(obj.align==='center') sx = obj.x - w/2; else if(obj.align==='right') sx = obj.x - w;
        return pos.x >= sx-20 && pos.x <= sx+w+20 && pos.y >= obj.y-40 && pos.y <= obj.y+20;
    }
    function isHitSticker(pos, s) { const w=s.baseWidth*s.scale; const h=s.baseHeight*s.scale; return pos.x >= s.x && pos.x <= s.x+w && pos.y >= s.y && pos.y <= s.y+h; }

    canvas.addEventListener('mousedown', startDrag); canvas.addEventListener('touchstart', startDrag, {passive:false});
    canvas.addEventListener('mousemove', moveDrag); canvas.addEventListener('touchmove', moveDrag, {passive:false});
    canvas.addEventListener('mouseup', endDrag); canvas.addEventListener('touchend', endDrag);

    function startDrag(e) {
        const pos = getMousePos(e);
        for (let i = stickers.length - 1; i >= 0; i--) {
            if (stickers[i].layer === 'top' && isHitSticker(pos, stickers[i])) { 
                e.preventDefault(); isDragging=true; dragType='sticker'; dragIndex=i; selectSticker(i); startX=pos.x; startY=pos.y; return; 
            }
        }
        for (let i = textObjects.length - 1; i >= 0; i--) {
            if (isHitText(pos, textObjects[i])) { 
                e.preventDefault(); isDragging=true; dragType='text'; dragIndex=i; selectSticker(-1); startX=pos.x; startY=pos.y; return; 
            }
        }
        for (let i = stickers.length - 1; i >= 0; i--) {
            if (stickers[i].layer === 'bottom' && isHitSticker(pos, stickers[i])) { 
                e.preventDefault(); isDragging=true; dragType='sticker'; dragIndex=i; selectSticker(i); startX=pos.x; startY=pos.y; return; 
            }
        }
        selectSticker(-1);
    }
    
    function moveDrag(e) {
        if (isDragging) {
            e.preventDefault(); const pos=getMousePos(e);
            if (dragType==='text') { textObjects[dragIndex].x=pos.x; textObjects[dragIndex].y=pos.y; }
            else if (dragType==='sticker') { const s=stickers[dragIndex]; const w=s.baseWidth*s.scale; const h=s.baseHeight*s.scale; s.x=pos.x-w/2; s.y=pos.y-h/2; }
            draw();
        }
    }
    function endDrag() { isDragging=false; dragIndex=-1; }

    // DOWNLOAD
    window.downloadImage = function() {
        const link = document.createElement('a'); link.download = 'Menu_SPPG_GenZ.png'; link.href = canvas.toDataURL(); link.click();
    }

    // COPY TO CLIPBOARD
    window.copyImageToClipboard = async function() {
        const tempSelectedIndex = selectedStickerIndex;
        selectedStickerIndex = -1;
        draw(); 
        
        try {
            canvas.toBlob(async (blob) => {
                const item = new ClipboardItem({ "image/png": blob });
                await navigator.clipboard.write([item]);
                alert("‚ú® Yasss! Gambar berhasil disalin ke clipboard! Tinggal paste (Ctrl+V) di WA atau sosmed. üìãüî•");
            });
        } catch (err) {
            console.error(err);
            alert("ü•≤ Yah gagal copy. Browser kamu mungkin belum support fitur ini. Pake tombol download aja ya!");
        } finally {
            selectedStickerIndex = tempSelectedIndex;
            draw();
        }
    }

    // --- FITUR KEAMANAN (ANTI INSPECT & CTRL+U) ---
    // Matikan Klik Kanan
    document.addEventListener('contextmenu', function(e) {
        e.preventDefault();
    });

    // Matikan Shortcut Keyboard (F12, Ctrl+Shift+I, Ctrl+Shift+J, Ctrl+U, dll)
    document.addEventListener('keydown', function(e) {
        if (
            e.key === 'F12' || 
            (e.ctrlKey && e.shiftKey && (e.key === 'I' || e.key === 'i' || e.key === 'J' || e.key === 'j' || e.key === 'C' || e.key === 'c')) || 
            (e.ctrlKey && (e.key === 'U' || e.key === 'u'))
        ) {
            e.preventDefault();
            return false;
        }
    });
</script>

</body>
</html>